<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Flip</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        #lobbies {
            width: 80%;
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
        }

        .lobby {
            border-bottom: 1px solid #eee;
            padding: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lobby:last-child {
            border-bottom: none;
        }

        button {
            padding: 8px 12px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1>Coin Flip Game</h1>

    <div>
        <h2>Create Lobby</h2>
        <input type="text" id="lobbyName" placeholder="Lobby Name">
        <input type="number" id="betAmount" placeholder="Bet Amount">
        <input type="number" id="rounds" placeholder="Number of Rounds">
        <input type="text" id="creatorId" placeholder="Your User ID">
        <button onclick="createLobby()">Create Lobby</button>
    </div>

    <div id="lobbies">
        <h2>Available Lobbies</h2>
        <!-- Lobbies will be displayed here -->
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000'; // Use a constant for base URL

        async function createLobby() {
            const name = document.getElementById('lobbyName').value;
            const betAmount = document.getElementById('betAmount').value;
            const rounds = document.getElementById('rounds').value;
            const creatorId = document.getElementById('creatorId').value;

            const response = await fetch(`${API_BASE_URL}/lobbies`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    betAmount: betAmount,
                    rounds: rounds,
                    creatorId: creatorId
                }),
            });

            const data = await response.json();
            console.log(data);
            fetchLobbies(); // Refresh lobby list after creating a lobby
        }
        async function fetchLobbies() {
            const response = await fetch(`${API_BASE_URL}/lobbies`);
            const lobbies = await response.json();

            const lobbiesDiv = document.getElementById('lobbies');
            lobbiesDiv.innerHTML = '<h2>Available Lobbies</h2>'; // Clear existing lobbies

            lobbies.forEach(lobby => {
                const lobbyDiv = document.createElement('div');
                lobbyDiv.classList.add('lobby');
                lobbyDiv.innerHTML = `
                    <span>${lobby.name} (Bet: ${lobby.bet_amount}, Rounds: ${lobby.rounds})</span>
                    <button onclick="joinLobby(${lobby.id}, '${document.getElementById('creatorId').value}')">Join Lobby</button>
                `;  // Pass lobby.id and userId
                lobbiesDiv.appendChild(lobbyDiv);
            });
        }

        async function joinLobby(lobbyId, userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/lobbies/${lobbyId}/join`, { // Correct URL
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId: userId }) // Send userId in the body
                });

                if (!response.ok) {
                    throw new Error(`Error joining lobby: HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Lobby joined:', data);
                alert(data.message); // Display a message to the user

            } catch (error) {
                console.error('Error joining lobby:', error);
                alert("Failed to join lobby. See console for details."); // Display a user-friendly error
            }
        }

        // Fetch lobbies on page load
        fetchLobbies();
    </script>
</body>

</html>
